<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Luca Nils Schmid</title>
  <style>/*!
 * Writ v1.0.2
 *
 * Copyright Â© 2015, Curtis McEnroe <curtis@cmcenroe.me>
 *
 * https://cmcenroe.me/writ/LICENSE (ISC)
 */dd,hr,ol ol,ol ul,ul ol,ul ul{margin:0}pre,table{overflow-x:auto}a,ins{text-decoration:none}html{font-family:Palatino,Georgia,Lucida Bright,Book Antiqua,serif;font-size:16px;line-height:1.5rem}code,kbd,pre,samp{font-family:Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:.833rem;color:#111}kbd{font-weight:700}h1,h2,h3,h4,h5,h6,th{font-weight:400}h1{font-size:2.488em}h2{font-size:2.074em}h3{font-size:1.728em}h4{font-size:1.44em}h5{font-size:1.2em}h6{font-size:1em}small{font-size:.833em}h1,h2,h3{line-height:3rem}blockquote,dl,h1,h2,h3,h4,h5,h6,ol,p,pre,table,ul{margin:1.5rem 0 0}pre,table{margin-bottom:-1px}hr{border:none;padding:1.5rem 0 0}table{line-height:calc(1.5rem - 1px);width:100%;border-collapse:collapse}pre{margin-top:calc(1.5rem - 1px)}body{color:#222;margin:1.5rem 1ch}a,nav a:visited{color:#00e}a:visited{color:#60b}mark{color:inherit;background-color:#fe0}code,pre,samp,tfoot,thead{background-color:rgba(0,0,0,.05)}blockquote,ins,main aside{border:rgba(0,0,0,.05) solid}blockquote,main aside{border-width:0 0 0 .5ch}code,pre,samp{border:rgba(0,0,0,.1) solid}td,th{border:solid #dbdbdb}body>header{text-align:center}body>footer,main{display:block;max-width:78ch;margin:auto}main aside,main figure{float:right;margin:1.5rem 0 0 1ch}main aside{max-width:26ch;padding:0 0 0 .5ch}blockquote{margin-right:3ch;margin-left:1.5ch;padding:0 0 0 1ch}pre{border-width:1px;border-radius:2px;padding:0 .5ch}pre code{border:none;padding:0;background-color:transparent;white-space:inherit}code,ins,samp,td,th{border-width:1px}img{max-width:100%}dd,ol,ul{padding:0 0 0 3ch}ul>li{list-style-type:disc}li ul>li{list-style-type:circle}li li ul>li{list-style-type:square}ol>li{list-style-type:decimal}li ol>li{list-style-type:lower-roman}li li ol>li{list-style-type:lower-alpha}nav ul{padding:0;list-style-type:none}nav ul li{display:inline;padding-left:1ch;white-space:nowrap}nav ul li:first-child{padding-left:0}ins,mark{padding:1px}td,th{padding:0 .5ch}sub,sup{font-size:.75em;line-height:1em}code,samp{border-radius:2px;padding:.1em .2em;white-space:nowrap}

</style>
  <style>*, *::before, *::after {
  box-sizing: border-box;
}

body {
  background: #FFF;
  margin: 0;
}

p:first-child {
  margin-top: 0;
}

footer {
  padding-top: 10vh;
  text-align: right;
}

section:not(:first-of-type) {
  margin-top: 3rem;
}

section:not(:first-of-type)::before {
  content: '';
  display: block;
  height: 1px;
  width: 100%;
  margin: 1rem 0 0 0;
  background-color: #DDD;
}

work-in-progress {
  height: auto;
}

main {
  margin: 1.5rem auto;
  -webkit-transition: margin-top .2s;
  transition: margin-top .2s;
}

nav a.current {
  text-decoration: underline;
}

@media (max-width: 900px) {
  aside {
    display: none;
  }
}

@media (max-width: 80ch) {
  main,
  body > footer {
    margin: 1.5rem 2ch;
  }
}

</style>
    <meta name="viewport" content="width&#x3D;device-width,initial-scale&#x3D;1"/>
    <meta name="description" content="My name is Luca Nils Schmid. This is my portfolio."/>
    <meta name="keywords" content="luca nils schmid, kriegslustig, webdevelopment, node.js"/>
  <link rel="alternate" title="Atom Feed" href="https://lucaschmid.net">
  <link rel="alternate" title="RSS Feed" href="https://lucaschmid.net">
</head>
<body>
  <work-in-progress></work-in-progress>
  <main>
    <aside>
      <custom-navigation></custom-navigation>
    </aside>
    <nav>
      <ul>
        <li><a class="" href="/">About</a></li>
        <li><a href="/projects">Projects</a></li>
        <li><a href="/anotherblog">Blog</a></li>
      </ul>
    </nav>
      <article>
    <h1 id="letsencryptexpress0"><a href="https://lucaschmid.net/anotherblog/letsencrypt-express">Let's encrypt Express</a></h1>

<p>Since <a href="https://letsencrypt.org/"><em>Let's Encrypt</em></a> will be coming out <a href="https://letsencrypt.org/2015/11/12/public-beta-timing.html">soon</a>, I thought I'd try it on my Site. <em>Let's Encrypts</em> infrastructure is actually fully operational already. They still label it as being in beta, because the client has some (<a href="https://github.com/letsencrypt/letsencrypt/issues">around 400</a>) bugs. My Site runs on Node.js using Express on <a href="https://alpinelinux.org/"><em>Alpine Linux</em></a>. The guide should work on pretty much any Linux system, since both <em>Node.js</em> and <em>Let's Encrypt</em> are made to be as cross-platform-compatible as possible.</p>

<p>I'll be covering three things in this guide. <strong>Requesting the certificate</strong>, <strong>Installing it to the Express app</strong> and <strong>A simple Express app running over TLS</strong>.</p>

<h2 id="requestingthecertificate">Requesting the certificate</h2>

<p>First of all lets get our certificate. I basically just followed the <a href="https://github.com/letsencrypt/letsencrypt/blob/master/README.rst">README inside Let's Encrypt's Github repo</a>.</p>

<p>We'll need to install the utility. This will become easier once it's released as stable. You'll then be able to use your package-manager.</p>

<pre><code>git clone https://github.com/letsencrypt/letsencrypt
cd letsencrypt
./letsencrypt-auto --help
</code></pre>

<p>Then we can request the certificate. Here's what I did for this site.</p>

<pre><code>./letsencrypt-auto certonly --standalone --email not_an_email_address@lucaschmid.net -d lucaschmid.net
</code></pre>

<p>This threw an error on my server because I had IPv6 enabled. If <a href="https://github.com/letsencrypt/boulder/issues/1046">this issue</a> hasn't been resolved yet, <strong>you might need to do deactivate IPv6</strong>, before running the last command.</p>

<pre><code>sysctl -w net.ipv6.conf.all.disable_ipv6=1
</code></pre>

<p>When you now run the last command again, you should recieve the certificate. After that, you can enable IPv6 again.</p>

<pre><code>sysctl -w net.ipv6.conf.all.disable_ipv6=0
</code></pre>

<h2 id="installingthecertificatetotheexpressapp">Installing the certificate to the Express app</h2>

<p>Inside my app's directory I created a directory called <code>tls</code>. I then created some symlinks for the certificate and the key.</p>

<pre><code>mkdir tls
cd tls
ln -s /etc/letsencrypt/live/lucaschmid.net/cert.pem
ln -s /etc/letsencrypt/live/lucaschmid.net/privkey.pem key.pem
</code></pre>

<p><em>I'm using Docker to run this site, so the symlinks won't work inside the container. To fix this, I had to make copies of the files instead of only symlinking them. This has the disadvantage of Let’s Encrypt not being able to manage them. The certificates have a pretty short lifetime (3 months), letsencrypt could renew them itself.</em></p>

<h2 id="asimpleexpressapprunningovertls">A simple Express app running over TLS</h2>

<p>Now we can integrate the <code>https</code> module into our Express server. Here's a simple example:</p>

<pre><code>var express = require('express')
var fs = require('fs')
var https = require('https')

var ports = process.env.NODE_ENV === 'production'
  ? [80, 443]
  : [3442, 3443]

var app = express()

var server = https.createServer(
  {
    key: fs.readFileSync('./tls/key.pem'),
    cert: fs.readFileSync('./tls/cert.pem')
  },
  app
)

server.listen(ports[1][7])
app.listen(ports[0])

app.use('/', (req, res) =\&gt; {
  res.end('Hi')
})
</code></pre>

<p>This script simply serves 'Hi' on all routes both over HTTP and HTTPS. It might be a good idea to redirect HTTP to HTTPS. I just wanted to keep it as simple as possible here.</p>

<p>When you run this and go to your Website via HTTPS, you should see something like this:
<img src="https://lucaschmid.net/_img/certificate.png" alt="Image of the certificate opened in Firefox" /></p>

<p>Now go on!</p>

<p><strong>ENCRYPT ALL THE THINGS!!</strong></p>
    <p>
      <i>– By <a href="author.url">Luca Nils Schmid</a></i><br>
      <i>Created on Sun Dec 27 2015 22:44:26 GMT+0100 (CET)</i>
    </p>
  </article>


  </main>
  <footer>
    <p><i>Made with love.</i></p>
  </footer>
  <script src="/_js/script.js"></script>
  <script src="/_tag/custom-navigation.js"></script>
  <script src="/_tag/work-in-progress.js"></script>
</body>
</html>

